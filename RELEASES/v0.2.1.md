# Quest System v0.2.1 - Release Notes

**Release Date**: October 10, 2025  
**Commit**: [0f125fe](https://github.com/smajla82-hub/7D2DBohemia/commit/0f125fe5da361dd03d587ad12aa3f4933dcbf2b2)

## Summary

Version 0.2.1 introduces a fully configurable quest system with permanent vote and levelgain quests, rotating daily challenges, and enhanced auto-claim functionality. All quest parameters (reset time, rewards, targets) are now adjustable via Takaro's User config interface without code changes.

## Key Features

### Permanent Quests (ALWAYS Active)
- **Vote Quest**: Reward players for voting for your server
- **Levelgain Quest**: Encourage progression and XP grinding

Both quests are **always** active and do not rotate.

### Rotating Daily Quests
Three additional quest types rotate daily from this pool:
- **Unkillable Quest**: Survive X hours without dying
- **Die Once Quest**: Die exactly once (strategic challenge)
- **Feral Kills Quest**: Kill X feral zombies
- **Vulture Kills Quest**: Kill X vultures
- **Time Spent Quest**: Play for X hours
- **Zombie Kills Quest**: Kill X zombies total
- **Shop Quest**: Purchase from shop X times

**Deterministic Rotation**: All players on a server see the same daily quests. Rotation is based on server ID and date for consistency.

### Configurable Quest System

All quest parameters are now configurable via Takaro module installer's "User config" dialog:

#### Reset Time
- **quest_reset_time_hhmm**: Set daily reset time in HH:mm format (Europe/Prague timezone)
- Default: `"00:15"` (12:15 AM Prague time)
- Cron runs every 5 minutes but executes reset only once per day

#### Reward Configuration (Currency/Beers)
All reward amounts are customizable:
- `reward_default_beers`: Standard rotating quests (Default: 25)
- `reward_vote_beers`: Voting quest (Default: 50)
- `reward_unkillable_beers`: Unkillable quest (Default: 50)
- `reward_dieonce_beers`: Die-once quest (Default: 50)
- `reward_feralkills_beers`: Feral kills quest (Default: 25)
- `reward_vulturekills_beers`: Vulture kills quest (Default: 25)

#### Quest Target Configuration
Customize quest difficulty:
- `target_timespent_ms`: Time to play (Default: 3600000 = 1 hour)
- `target_unkillable_ms`: Time without dying (Default: 10800000 = 3 hours)
- `target_feralkills`: Feral zombies to kill (Default: 10)
- `target_vulturekills`: Vultures to kill (Default: 10)
- `target_dieonce`: Deaths required (Default: 1)
- `target_zombiekills`: Total zombies to kill (Default: 200)
- `target_levelgain`: Levels to gain (Default: 5)
- `target_shopquest`: Shop purchases needed (Default: 1)

#### Optional Settings
- `enable_time_tracking`: Toggle time-based quest tracking (Default: true)

### Auto-Claim Improvements

#### Enqueue on External Completion
When external systems (voting script, integration server) mark a quest as completed, the reward is now **enqueued** for auto-claim processing. This ensures:
- Reliable reward delivery even during server load
- Consistent behavior between internal and external quest completions
- No duplicate rewards

#### Fallback for Completed-But-Unclaimed
The auto-claim cronjob now polls for quests that are:
1. Marked as completed but not yet claimed
2. Not in the processing queue

This fallback ensures rewards are never missed, even if the initial enqueue fails.

### ASCII-Only Private Messages

All player private messages now use **ASCII-safe characters only**:
- Removed Unicode emoji and special characters
- Uses BMP-safe symbols: ✪ (title wrapper), ※ (bullet), ✔ (checkmark)
- Prevents encoding issues and server console errors
- Clean, readable messages on all platforms

### Technical Improvements

#### Shared Config Loader
New `Functions/questConfig.js` utility provides:
- `getQuestConfig()`: Load all config with fallback defaults
- `getTargetFor(questType)`: Get target value for any quest type
- `getRewardFor(questType)`: Get reward amount for any quest type

#### Once-Per-Day Guard
- `dailyquests_last_reset_at` variable ensures reset runs exactly once per day
- Prevents duplicate resets even if cron runs multiple times

#### Flexible Cron Scheduling
- `autoInitDailyQuests.js` can safely run every 5 minutes (*/5 * * * *)
- Internal time-based gating checks `quest_reset_time_hhmm` config
- No longer requires precise cron timing

#### Error Diagnostics
- `questdiag_last_error` variable logs config and guard errors
- Easier troubleshooting via Takaro dashboard

#### Retention Cleanup
Old quest variables are automatically cleaned up to prevent database bloat.

#### Prague Timezone
All time logic uses **Europe/Prague** (CET/CEST) timezone for consistency.

## Migration from Previous Versions

### From v0.1.2 or Earlier
1. Update all module files (see deployment section below)
2. Configure User config values in Takaro installer
3. Update `autoInitDailyQuests.js` cron to run every 5 minutes (optional)
4. Set `quest_reset_time_hhmm` to your preferred reset time

**No data migration needed**: The module automatically uses defaults if config is not set, maintaining backward compatibility.

### Breaking Changes
None. Existing installations will continue to work with default values.

## Deployment

For complete deployment instructions, see [DEPLOY.md](../DEPLOY.md).

### Quick Deployment Checklist

1. **Update Takaro Module Files** (copy from permalinks below)
   - [ ] Commands/daily.js
   - [ ] Commands/resetmydaily.js
   - [ ] Cronjobs/autoInitDailyQuests.js
   - [ ] Cronjobs/autoClaimRewards.js
   - [ ] Cronjobs/questTracker.js
   - [ ] Hooks/playerConnect.js
   - [ ] Functions/questConfig.js

2. **Configure User Config Values**
   - [ ] Set `quest_reset_time_hhmm` (e.g., "00:15")
   - [ ] Configure reward amounts (default_beers, vote_beers, etc.)
   - [ ] Configure quest targets (zombiekills, levelgain, etc.)
   - [ ] Set `enable_time_tracking` (default: true)

3. **Set Cronjob Schedules**
   - [ ] autoInitDailyQuests: Every 5 minutes (*/5 * * * *)
   - [ ] questTracker: Every 15 seconds
   - [ ] autoClaimRewards: Every 15 seconds

4. **Deploy Server Integration** (on game host)
   - [ ] Install/update working_server.js (port 3000)
   - [ ] Install/update takaro_client.js (v2.1)
   - [ ] Install/update voting_rewards.py (v34)
   - [ ] Configure and start with PM2

5. **Verify Installation**
   - [ ] Test `/daily` command
   - [ ] Test voting quest update
   - [ ] Test auto-claim reward
   - [ ] Check server variables in Takaro

## Module Files (v0.2.1 - Commit 0f125fe)

Use these permalink URLs to copy the exact version for v0.2.1:

### Takaro Module Files

**Commands:**
- [daily.js](https://github.com/smajla82-hub/7D2DBohemia/blob/0f125fe5da361dd03d587ad12aa3f4933dcbf2b2/QUEST%20MODULE%20v0.1.0/Commands/daily.js)
- [resetmydaily.js](https://github.com/smajla82-hub/7D2DBohemia/blob/0f125fe5da361dd03d587ad12aa3f4933dcbf2b2/QUEST%20MODULE%20v0.1.0/Commands/resetmydaily.js)

**Cronjobs:**
- [autoInitDailyQuests.js](https://github.com/smajla82-hub/7D2DBohemia/blob/0f125fe5da361dd03d587ad12aa3f4933dcbf2b2/QUEST%20MODULE%20v0.1.0/Cronjobs/autoInitDailyQuests.js)
- [autoClaimRewards.js](https://github.com/smajla82-hub/7D2DBohemia/blob/0f125fe5da361dd03d587ad12aa3f4933dcbf2b2/QUEST%20MODULE%20v0.1.0/Cronjobs/autoClaimRewards.js)
- [questTracker.js](https://github.com/smajla82-hub/7D2DBohemia/blob/0f125fe5da361dd03d587ad12aa3f4933dcbf2b2/QUEST%20MODULE%20v0.1.0/Cronjobs/questTracker.js)

**Hooks:**
- [playerConnect.js](https://github.com/smajla82-hub/7D2DBohemia/blob/0f125fe5da361dd03d587ad12aa3f4933dcbf2b2/QUEST%20MODULE%20v0.1.0/Hooks/playerConnect.js)

**Functions:**
- [questConfig.js](https://github.com/smajla82-hub/7D2DBohemia/blob/0f125fe5da361dd03d587ad12aa3f4933dcbf2b2/QUEST%20MODULE%20v0.1.0/Functions/questConfig.js)

### Server Integration Files

**Node.js Integration Server:**
- [working_server.js](https://github.com/smajla82-hub/7D2DBohemia/blob/0f125fe5da361dd03d587ad12aa3f4933dcbf2b2/takaro-quest-integration_server/working_server.js) (HTTP server, port 3000)
- [takaro_client.js](https://github.com/smajla82-hub/7D2DBohemia/blob/0f125fe5da361dd03d587ad12aa3f4933dcbf2b2/takaro-quest-integration_server/takaro_client.js) (v2.1 with enqueue + ASCII PMs)

**Python Voting Script:**
- [voting_rewards.py](https://github.com/smajla82-hub/7D2DBohemia/blob/0f125fe5da361dd03d587ad12aa3f4933dcbf2b2/Voting/voting_rewards.py) (v34 with automatic_vote_checker restored)

## Configuration Guide

For detailed configuration documentation, see:
- [CONFIG_GUIDE.md](../QUEST%20MODULE%20v0.1.0/CONFIG_GUIDE.md) - Complete configuration reference
- [DEPLOY.md](../DEPLOY.md) - Step-by-step deployment guide

### Default Configuration (Recommended)

```javascript
// Reset time
quest_reset_time_hhmm: "00:15"  // 12:15 AM Prague time

// Rewards (currency/beers)
reward_default_beers: 25
reward_vote_beers: 50
reward_unkillable_beers: 50
reward_dieonce_beers: 50
reward_feralkills_beers: 25
reward_vulturekills_beers: 25

// Targets
target_timespent_ms: 3600000     // 1 hour
target_unkillable_ms: 10800000   // 3 hours
target_feralkills: 10
target_vulturekills: 10
target_dieonce: 1
target_zombiekills: 200
target_levelgain: 5
target_shopquest: 1

// Optional
enable_time_tracking: true
```

## Changelog

See [CHANGELOG.md](../QUEST%20MODULE%20v0.1.0/CHANGELOG.md) for complete version history.

### v0.2.1 Changes
- Vote and levelgain are now permanent (ALWAYS active)
- Three rotating daily quests instead of two
- All quest parameters configurable via User config
- Auto-claim enqueue support for external completions
- ASCII-only private messages
- Deterministic daily rotation
- Retention cleanup for old variables
- Prague timezone consistency
- Once-per-day guard for reset execution
- Flexible cron scheduling (5-minute intervals)
- Shared config loader utility
- Error diagnostics variable

## Known Issues

None at this time.

## Support

For issues, questions, or feedback:
- **GitHub Issues**: [https://github.com/smajla82-hub/7D2DBohemia/issues](https://github.com/smajla82-hub/7D2DBohemia/issues)
- **Documentation**: [DEPLOY.md](../DEPLOY.md) | [CONFIG_GUIDE.md](../QUEST%20MODULE%20v0.1.0/CONFIG_GUIDE.md)

## Credits

Developed for 7 Days to Die servers using the Takaro platform.

## License

This project is provided as-is for use with 7 Days to Die servers.

---

**Note**: The module folder name "QUEST MODULE v0.1.0" is historical and does not reflect the current version. The true release version is maintained in GitHub Releases and this changelog. Always reference the GitHub Release tag (v0.2.1) for the canonical version.
